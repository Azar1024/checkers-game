<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:CheckersGame.ViewModels"
        xmlns:models="using:CheckersGame.Models"
        x:Class="CheckersGame.Views.MainWindow"
        x:DataType="vm:GameViewModel"
        Title="Русские шашки - Онлайн"
        Width="600" Height="650"
        Icon="avares://CheckersGame/Assets/icon.ico">

    <Window.Resources>
        <vm:IsNotNullConverter x:Key="IsNotNullConverter" />
        <vm:IsFalseConverter x:Key="IsFalseConverter" />
        <vm:CellBackgroundConverter x:Key="CellBackgroundConverter" />
        <vm:SelectedCellHighlightConverter x:Key="SelectedCellHighlightConverter" />
        <vm:OccupiedAndNotWhiteConverter x:Key="OccupiedAndNotWhiteConverter" />
    </Window.Resources>

    <Window.Background>
        <ImageBrush Source="avares://CheckersGame/Assets/background.jpg"
                    Stretch="UniformToFill" />
    </Window.Background>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0"
                   Text="{Binding Status}"
                   FontSize="20"
                   Foreground="Black"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,15"/>

        <!-- Кнопка "В главное меню" -->
        <Button Grid.Row="0"
                Content="← В главное меню"
                Command="{Binding ReturnToMenuCommand}"
                Background="Transparent"
                Foreground="#AAA"
                HorizontalAlignment="Left"
                Margin="0,0,0,15">
            <Button.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Button.IsVisible>
        </Button>

        <!-- Кнопка "?" -->
        <Button Grid.Row="0"
                Content="?"
                FontSize="20"
                FontWeight="Bold"
                Width="40"
                Height="40"
                Background="#007BFF"
                Foreground="White"
                CornerRadius="20"
                HorizontalAlignment="Right"
                Margin="0,0,20,0"
                Command="{Binding ToggleRulesCommand}">
            <Button.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Button.IsVisible>
        </Button>

        <!-- СТАРТОВЫЙ ЭКРАН -->
        <Viewbox Grid.Row="1" Stretch="Uniform" IsVisible="{Binding IsStartScreen}">
            <StackPanel Spacing="20">
                <TextBlock Text="Русские шашки"
                           FontSize="25"
                           HorizontalAlignment="Center"/>
                <Button Width="300" Content="Человек vs Человек"
                        Command="{Binding StartHumanVsHumanCommand}"/>
                <Button Width="300" Content="Человек vs ИИ"
                        Command="{Binding StartHumanVsAICommand}"/>
                <Button Width="300" Content="Играть Онлайн"
                        Command="{Binding OpenOnlineLobbyCommand}"/>
                <Button Width="300" Content="Выход"
                        Command="{Binding ExitCommand}"/>
            </StackPanel>
        </Viewbox>

        <!-- ЛОББИ -->
        <Border Grid.Row="1"
                Background="#F0222222"
                CornerRadius="15"
                Padding="25"
                BorderBrush="#444"
                BorderThickness="2"
                IsVisible="{Binding IsLobbyScreen}">
            <!-- содержимое без изменений -->
        </Border>

        <!-- GAME OVER -->
        <Viewbox Grid.Row="1" Stretch="Uniform" IsVisible="{Binding IsGameOver}">
            <StackPanel>
                <Button Width="300"
                        Height="40"
                        Content="Вернуться в главное меню"
                        Command="{Binding ReturnToMenuCommand}"/>
            </StackPanel>
        </Viewbox>

        <!-- ИГРОВОЕ ПОЛЕ -->
        <Viewbox Grid.Row="1" Stretch="Uniform">
            <Viewbox.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Viewbox.IsVisible>

            <ItemsControl ItemsSource="{Binding Grid}" Width="480" Height="480">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Rows="8" Columns="8"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemTemplate>
                    <DataTemplate x:CompileBindings="False">
                        <Button Width="60"
                                Height="60"
                                Command="{Binding $parent[Window].DataContext.CellCommand}"
                                CommandParameter="{Binding}">

                            <Button.Background>
                                <MultiBinding Converter="{StaticResource CellBackgroundConverter}">
                                    <Binding Path="Row"/>
                                    <Binding Path="Col"/>
                                </MultiBinding>
                            </Button.Background>

                            <Panel>

                                <!-- БЕЛАЯ ШАШКА -->
                                <Ellipse Width="48"
                                         Height="48"
                                         Fill="#FFF"
                                         StrokeThickness="4"
                                         IsVisible="{Binding IsOccupied}">
                                    <Ellipse.Stroke>
                                        <MultiBinding Converter="{x:Static vm:SelectedPieceStrokeConverter.Instance}">
                                            <Binding Path="DataContext.Selected"
                                                     RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                            <Binding Path="Row"/>
                                            <Binding Path="Col"/>
                                        </MultiBinding>
                                    </Ellipse.Stroke>
                                </Ellipse>

                                <!-- ЧЁРНАЯ ШАШКА -->
                                <Ellipse Width="48"
                                         Height="48"
                                         Fill="#222"
                                         StrokeThickness="4">
                                    <Ellipse.Stroke>
                                        <MultiBinding Converter="{x:Static vm:SelectedPieceStrokeConverter.Instance}">
                                            <Binding Path="DataContext.Selected"
                                                     RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                            <Binding Path="Row"/>
                                            <Binding Path="Col"/>
                                        </MultiBinding>
                                    </Ellipse.Stroke>

                                    <Ellipse.IsVisible>
                                        <MultiBinding Converter="{StaticResource OccupiedAndNotWhiteConverter}">
                                            <Binding Path="IsOccupied"/>
                                            <Binding Path="IsWhite"/>
                                        </MultiBinding>
                                    </Ellipse.IsVisible>
                                </Ellipse>

                                <!-- ДАМКА -->
                                <Path Data="M12,4 L18,10 L12,16 L6,10 Z"
                                      Fill="Gold"
                                      Width="20"
                                      Height="20"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      IsVisible="{Binding IsKing}"/>
                            </Panel>

                            <!-- ПОДСВЕТКА КЛЕТКИ -->
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <MultiBinding Converter="{StaticResource SelectedCellHighlightConverter}">
                                                <Binding Path="DataContext.Selected"
                                                         RelativeSource="{RelativeSource AncestorType=ItemsControl}"/>
                                                <Binding Path="Row"/>
                                                <Binding Path="Col"/>
                                            </MultiBinding>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Styles>

                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Viewbox>

        <!-- ОКНО ПРАВИЛ -->
         <Panel Background="#CC000000"
               IsVisible="{Binding IsRulesVisible}"
               HorizontalAlignment="Center"
               VerticalAlignment="Center">
            <Panel.ZIndex>100</Panel.ZIndex>

            <Border Background="#333"
                    Padding="30"
                    CornerRadius="15"
                    BorderBrush="#555"
                    BorderThickness="2"
                    MaxWidth="700">
                <StackPanel Spacing="15">
                    <TextBlock Text="Правила русских шашек"
                               FontSize="24"
                               FontWeight="Bold"
                               Foreground="White"
                               HorizontalAlignment="Center"/>

                    <StackPanel Spacing="10">
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Обычные шашки ходят по диагонали вперёд на одну клетку."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Бить можно вперёд и назад. Бить обязательно!"/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Если после взятия можно бить дальше той же шашкой — бить продолжать."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Дойдя до последней горизонтали, шашка становится дамкой."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Дамка ходит и бьёт по диагонали на любое расстояние."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Победа — уничтожить все шашки противника или лишить его ходов."/>
    </TextBlock>
</StackPanel>

                    <Button Content="Закрыть"
                            Command="{Binding ToggleRulesCommand}"
                            Background="#DC3545"
                            Foreground="White"
                            HorizontalAlignment="Center"
                            Padding="15,8"/>
                </StackPanel>
            </Border>
        </Panel>

    </Grid>
</Window>

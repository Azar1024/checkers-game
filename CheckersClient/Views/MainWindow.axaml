<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:CheckersGame.ViewModels"
        xmlns:models="using:CheckersGame.Models"
        x:Class="CheckersGame.Views.MainWindow"
        x:DataType="vm:GameViewModel"
        Title="Русские шашки - Онлайн"
        Width="600" Height="650"
        Icon="avares://CheckersGame/Assets/icon.ico">
    <Window.Resources>
        <vm:IsNotNullConverter x:Key="IsNotNullConverter" />
        <vm:IsFalseConverter x:Key="IsFalseConverter" />
        <vm:CellBackgroundConverter x:Key="CellBackgroundConverter" />
        <vm:SelectedCellHighlightConverter x:Key="SelectedCellHighlightConverter" />
        <vm:OccupiedAndNotWhiteConverter x:Key="OccupiedAndNotWhiteConverter" />
    </Window.Resources>
    
    <Window.Background>
        <ImageBrush Source="avares://CheckersGame/Assets/background.jpg" Stretch="UniformToFill" />
    </Window.Background>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0"
                   Text="{Binding Status}"
                   FontSize="20"
                   Foreground="Black"
                   HorizontalAlignment="Center"
                   Margin="0,0,0,15"/>

        <!-- Кнопка "В главное меню" — видна только во время активной игры -->
        <Button Grid.Row="0"
                Content="← В главное меню"
                Command="{Binding ReturnToMenuCommand}"
                Background="Transparent"
                Foreground="#AAA"
                HorizontalAlignment="Left"
                Margin="0,0,0,15">
            <Button.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Button.IsVisible>
        </Button>

        <!-- Кнопка с вопросом — видна только во время активной игры -->
        <Button Grid.Row="0"
                Content="?"
                FontSize="20"
                FontWeight="Bold"
                Width="40" Height="40"
                Background="#007BFF"
                Foreground="White"
                CornerRadius="20"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="0,0,20,0"
                Command="{Binding ToggleRulesCommand}">
            <Button.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Button.IsVisible>
        </Button>

        <Viewbox Grid.Row="1" Stretch="Uniform" IsVisible="{Binding IsStartScreen}">
            <StackPanel Spacing="20" Orientation="Vertical">
                <TextBlock Text="Русские шашки" FontSize="25" Foreground="Black" HorizontalAlignment="Center"/>
                <Button Width="300" Height="30" Content="Человек vs Человек" Command="{Binding StartHumanVsHumanCommand}" Foreground="Black" />
                <Button Width="300" Height="30" Content="Человек vs ИИ" Command="{Binding StartHumanVsAICommand}" Foreground="Black" />
                <Button Width="300" Height="30" Content="Играть Онлайн" Command="{Binding OpenOnlineLobbyCommand}" Foreground="Black" />
                <Button Width="300" Height="30" Content="Выход" Command="{Binding ExitCommand}" Foreground="Black" />
            </StackPanel>
        </Viewbox>

        <Border Grid.Row="1" 
                Background="#F0222222" 
                CornerRadius="15" 
                Padding="25" 
                BorderBrush="#444" 
                BorderThickness="2"
                IsVisible="{Binding IsLobbyScreen}">
            <Grid RowDefinitions="Auto, Auto, *, Auto">
                
                <TextBlock Grid.Row="0" 
                           Text="ОНЛАЙН ЛОББИ" 
                           FontSize="24" 
                           FontWeight="Bold"
                           Foreground="White" 
                           HorizontalAlignment="Center" 
                           Margin="0,0,0,5"/>
                
                <TextBlock Grid.Row="1" 
                           Text="{Binding LobbyStatus}" 
                           FontSize="14" 
                           Foreground="#FFCC00" 
                           HorizontalAlignment="Center" 
                           Margin="0,0,0,15"
                           TextWrapping="Wrap"/>

                <Grid Grid.Row="2" ColumnDefinitions="*, 220">
                    <DockPanel Grid.Column="0" Margin="0,0,15,0">
                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="10" Margin="0,0,0,10">
                            <TextBlock Text="Доступные игры" Foreground="White" FontSize="16" VerticalAlignment="Center"/>
                            <Button Content="Обновить ↻" 
                                    Command="{Binding RefreshLobbiesCommand}" 
                                    Background="#444" 
                                    Foreground="White" 
                                    Padding="10,2"/>
                        </StackPanel>
                        
                        <ScrollViewer>
                            <ListBox ItemsSource="{Binding Lobbies}" 
                                     Background="#333" 
                                     BorderBrush="#555"
                                     BorderThickness="1"
                                     CornerRadius="5"
                                     MinHeight="200">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="#444" BorderThickness="0,0,0,1" Padding="8">
                                            <Grid ColumnDefinitions="*, Auto">
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Name}" Foreground="White" FontWeight="SemiBold"/>
                                                    <TextBlock Text="{Binding Id, StringFormat='ID: {0}'}" FontSize="12" Foreground="#AAA"/>
                                                </StackPanel>
                                                <Button Grid.Column="1" 
                                                        Content="Войти" 
                                                        Background="#28A745"
                                                        Foreground="White"
                                                        FontWeight="Bold"
                                                        Command="{Binding $parent[Window].DataContext.JoinSelectedGameCommand}"
                                                        CommandParameter="{Binding Id}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </ScrollViewer>
                    </DockPanel>

                    <StackPanel Grid.Column="1" Spacing="15">
                        <Border Background="#333" Padding="15" CornerRadius="8" BorderBrush="#555" BorderThickness="1">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Создать новую" Foreground="White" FontWeight="Bold"/>
                                <CheckBox Content="Приватная игра" 
                                          Foreground="White"
                                          IsChecked="{Binding IsCreatingPrivate}"/>
                                <Button Content="СОЗДАТЬ" 
                                        Background="#007BFF"
                                        Foreground="White"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Command="{Binding CreateGameCommand}"/>
                            </StackPanel>
                        </Border>

                        <Border Background="#333" Padding="15" CornerRadius="8" BorderBrush="#555" BorderThickness="1">
                            <StackPanel Spacing="10">
                                <TextBlock Text="Вход по коду" Foreground="White" FontWeight="Bold"/>
                                <TextBox Text="{Binding JoinGameId}" 
                                         Watermark="Введите Game ID"
                                         Background="#222"
                                         Foreground="White"
                                         BorderBrush="#555"/>
                                <Button Content="ПРИСОЕДИНИТЬСЯ" 
                                        Background="#6C757D"
                                        Foreground="White"
                                        HorizontalAlignment="Stretch"
                                        HorizontalContentAlignment="Center"
                                        Command="{Binding JoinGameCommand}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>

                <Button Grid.Row="3" 
                        Content="← В ГЛАВНОЕ МЕНЮ" 
                        Command="{Binding ReturnToMenuCommand}" 
                        Background="Transparent"
                        Foreground="#AAA"
                        HorizontalAlignment="Left"
                        Margin="0,15,0,0"/>
            </Grid>
        </Border>

        <Viewbox Grid.Row="1" Stretch="Uniform" IsVisible="{Binding IsGameOver}">
            <StackPanel Spacing="20" Orientation="Vertical">
                <Button Width="300" Height="40" FontSize="15" Content="Вернуться в главное меню" Command="{Binding ReturnToMenuCommand}" Foreground="Black" />
            </StackPanel>
        </Viewbox>

        <Viewbox Grid.Row="1" Stretch="Uniform">
            <Viewbox.IsVisible>
                <MultiBinding Converter="{x:Static BoolConverters.And}">
                    <Binding Path="!IsStartScreen"/>
                    <Binding Path="!IsLobbyScreen"/>
                    <Binding Path="!IsGameOver"/>
                </MultiBinding>
            </Viewbox.IsVisible>
            
            <ItemsControl ItemsSource="{Binding Grid}" Width="480" Height="480">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Rows="8" Columns="8"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:CompileBindings="False">
                        <Button Width="60" Height="60" Command="{Binding $parent[Window].DataContext.CellCommand}" CommandParameter="{Binding}">
                            <Button.Background>
                                <MultiBinding Converter="{StaticResource CellBackgroundConverter}">
                                    <Binding Path="Row" Mode="OneTime" />
                                    <Binding Path="Col" Mode="OneTime" />
                                </MultiBinding>
                            </Button.Background>
                            <Panel>
                                <Ellipse Width="48" Height="48" Fill="#FFF" Stroke="#333" StrokeThickness="2" IsVisible="{Binding IsOccupied, Mode=OneWay}"/>
                                <Ellipse Width="48" Height="48" Fill="#222" Stroke="#EEE" StrokeThickness="2">
                                    <Ellipse.IsVisible>
                                        <MultiBinding Converter="{StaticResource OccupiedAndNotWhiteConverter}">
                                            <Binding Path="IsOccupied" Mode="OneWay" />
                                            <Binding Path="IsWhite" Mode="OneWay" />
                                        </MultiBinding>
                                    </Ellipse.IsVisible>
                                </Ellipse>
                                <Path Data="M12,4 L18,10 L12,16 L6,10 Z" Fill="Gold" Stretch="Uniform" Width="20" Height="20" HorizontalAlignment="Center" VerticalAlignment="Center" IsVisible="{Binding IsKing, Mode=OneWay}"/>
                            </Panel>
                            <Button.Styles>
                                <Style Selector="Button">
                                    <Setter Property="Background">
                                        <Setter.Value>
                                            <MultiBinding Converter="{StaticResource SelectedCellHighlightConverter}">
                                                <Binding Path="DataContext.Selected" RelativeSource="{RelativeSource AncestorType=ItemsControl}" Mode="OneWay" />
                                                <Binding Path="Row" Mode="OneWay" />
                                                <Binding Path="Col" Mode="OneWay" />
                                            </MultiBinding>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Styles>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Viewbox>

        <!-- Окно с правилами — поверх всего -->
        <Panel Background="#CC000000"
               IsVisible="{Binding IsRulesVisible}"
               HorizontalAlignment="Center"
               VerticalAlignment="Center">
            <Panel.ZIndex>100</Panel.ZIndex>

            <Border Background="#333"
                    Padding="30"
                    CornerRadius="15"
                    BorderBrush="#555"
                    BorderThickness="2"
                    MaxWidth="700">
                <StackPanel Spacing="15">
                    <TextBlock Text="Правила русских шашек"
                               FontSize="24"
                               FontWeight="Bold"
                               Foreground="White"
                               HorizontalAlignment="Center"/>

                    <StackPanel Spacing="10">
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Обычные шашки ходят по диагонали вперёд на одну клетку."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Бить можно вперёд и назад. Бить обязательно!"/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Если после взятия можно бить дальше той же шашкой — бить продолжать."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Дойдя до последней горизонтали, шашка становится дамкой."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Дамка ходит и бьёт по диагонали на любое расстояние."/>
    </TextBlock>
    <TextBlock Foreground="White" FontSize="14">
        <Run Text="• " FontWeight="Bold"/>
        <Run Text="Победа — уничтожить все шашки противника или лишить его ходов."/>
    </TextBlock>
</StackPanel>

                    <Button Content="Закрыть"
                            Command="{Binding ToggleRulesCommand}"
                            Background="#DC3545"
                            Foreground="White"
                            HorizontalAlignment="Center"
                            Padding="15,8"/>
                </StackPanel>
            </Border>
        </Panel>
    </Grid>
</Window>